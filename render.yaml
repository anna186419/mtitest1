build:
  dockerfile: Dockerfile
  image: python:3.11-slim

deploy:
  command:
    - gunicorn
    - --workers 4
    - --threads 2
    - --timeout 90
    - --access-logfile "-"
    - --error-logfile "-"
    - --bind 0.0.0.0:8000
    - app:app
  ports:
    - 8000:8000
  env:
    FLASK_ENV: production
    FLASK_APP: app.py
    DATABASE_URL: sqlite:///instance/school.db
    SECRET_KEY: 33089f9e2eb17db8ddf07beb55ea2c12db505526b1f63f3963a352b2e10c9d26
    DEBUG: "false"
    JSON_SORT_KEYS: "false"
    # Дополнительные рекомендуемые переменные
    SESSION_COOKIE_SECURE: "true"  # Для HTTPS
    SESSION_COOKIE_HTTPONLY: "true"
    SESSION_COOKIE_SAMESITE: "Lax"

files:
  - requirements.txt
  - app.py
  - models.py
  - instance/
  - static/
  - templates/
  - migrations/
  - config.py

packages:
  - pip install -r requirements.txt
  - flask db upgrade

healthcheck:
  http:
    path: /health
    interval: 30s
    timeout: 5s
    retries: 3

resources:
  cpu: 1
  memory: 512MB

# Дополнительные секции
secrets:
  DATABASE_URL:
  SECRET_KEY:

logging:
  version: 1
  disable_existing_loggers: false
  handlers:
    console:
      class: logging.StreamHandler
      formatter: verbose
  loggers:
    app:
      level: INFO
      handlers: [console]

concurrency:
  max_requests: 1000
  max_requests_jitter: 100
